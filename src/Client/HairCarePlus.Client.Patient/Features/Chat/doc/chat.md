# Важно: Проект использует .NET MAUI 9.0.51 SR (стабильная версия)

# Приложение HairCare+ для пациентов: Функция чата

## Обзор

Функция чата в приложении HairCare+ для пациентов обеспечивает коммуникацию в реальном времени между пациентами и медицинскими работниками. Интерфейс выполнен в стиле современного приложения для обмена сообщениями с поддержкой текстовых сообщений, вложений, функции ответа и индикаторов статуса.

## Архитектура

Функция чата следует архитектурному паттерну MVVM и принципам Clean Architecture:

- **Модели**: Определяют структуры данных для сообщений чата
- **Представления**: XAML UI-компоненты со стилями и поведениями
- **Модели представлений**: Бизнес-логика с командами и свойствами
- **Конвертеры**: Преобразуют данные для отображения в интерфейсе
- **Поведения**: Обрабатывают взаимодействия с пользовательским интерфейсом

## Функциональность

### Текущая реализация

1. **Базовый обмен сообщениями**
   - Отправка и получение текстовых сообщений
   - Визуальное различие между отправленными и полученными сообщениями
   - Отображение временной метки для каждого сообщения
   - Автоматическая прокрутка к последнему сообщению

2. **Функция ответа**
   - Ответ на конкретные сообщения осуществляется простым нажатием на сообщение от доктора
   - Предварительный просмотр ответа в цепочке сообщений
   - Визуальное выделение сообщения, на которое отвечают
   - Возможность отмены ответа через кнопку закрытия (×)
   - Отвечать можно только на сообщения от доктора, не на свои собственные

3. **Пользовательский опыт**
   - Стилизация сообщений в зависимости от отправителя (пациент или врач)
   - Индикатор статуса онлайн/оффлайн
   - Обработка клавиатуры с автоматической подстройкой прокрутки
   - Поддержка светлой/темной темы
   - Режим редактирования собственных сообщений через свайп влево

4. **Компоненты интерфейса**
   - Заголовок чата с информацией о враче
   - Пузыри сообщений с соответствующим стилем
   - Область ввода с расширяемым текстовым полем
   - Меню опций для вложений

### Планируемые функции (В РАЗРАБОТКЕ)

1. **Поддержка медиа-контента**
   - Интеграция с камерой для съемки фотографий
   - Интеграция с галереей для выбора существующих изображений
   - Предварительный просмотр медиа-контента в цепочке чата

2. **Статус сообщений**
   - Индикаторы доставки (отправлено/доставлено/прочитано)
   - Визуализация состояния отправки сообщения

3. **Дополнительные функции**
   - Поиск сообщений (В РАЗРАБОТКЕ)
   - Редактирование сообщений (РЕАЛИЗОВАНО)
   - Удаление сообщений (В РАЗРАБОТКЕ)
   - Обработка медиа-файлов (В РАЗРАБОТКЕ)

## Дизайн UI/UX

### Цветовая схема

- **Сообщения пациента**: Светло-голубые пузыри (#EAF4FC в светлой теме, #1E2A35 в темной теме)
- **Сообщения врача**: Зеленые пузыри (#A0DAB2 в светлой теме, #4D7B63 в темной теме)
- **Фон интерфейса**: Светло-серый в светлой теме (#F7F7F7), темный в темной теме (#121212)
- **Цвета текста**: Черный/белый с достаточным контрастом для удобства чтения

### Макет

1. **Заголовок**
   - Кнопка "Назад" (выравнивание по левому краю)
   - Имя врача (выравнивание по центру)
   - Индикатор статуса онлайн (выравнивание по правому краю)

2. **Список сообщений**
   - CollectionView с пользовательским шаблоном элементов
   - Сообщения пациента выровнены по правому краю
   - Сообщения врача выровнены по левому краю
   - Индикаторы ответов, когда применимо
   - Автоматическая прокрутка вниз

3. **Секция ввода**
   - Кнопка вложений (значок +)
   - Текстовое поле с изменяемой высотой
   - Кнопка отправки (появляется при вводе текста)
   - Предпросмотр ответа (при ответе на сообщение)

### Детали стилизации

1. **Пузыри сообщений**
   - Скругленные углы (радиус 18px)
   - Эффект тени для глубины
   - Ограничение максимальной ширины (280px)
   - Отступы для комфортного чтения
   - Выравнивание справа/слева в зависимости от отправителя

2. **Интерфейс ответа**
   - Визуальный индикатор для выбранного сообщения
   - Предпросмотр сообщения, на которое отвечают, в новом сообщении
   - Возможность отмены (кнопка ×)
   - Тонкое различие в цвете фона

3. **Область ввода**
   - Скругленное поле ввода (радиус 18px)
   - Изменяемая высота в зависимости от содержимого
   - Меню вложений с выпадающими опциями
   - Кнопка отправки появляется динамически

## Взаимодействия

1. **Отправка сообщений**
   - Проверка текста для предотвращения отправки пустых сообщений
   - Очистка поля ввода после отправки
   - Автоматическая прокрутка к новому сообщению
   - Поддержка контекста ответа

2. **Ответ на сообщения**
   - Простое нажатие на сообщение доктора для создания ответа (без дополнительного подтверждения)
   - Визуальное выделение выбранного для ответа сообщения
   - Отображение предпросмотра сообщения, на которое отвечают
   - Возможность отмены ответа через кнопку закрытия
   
3. **Редактирование сообщений**
   - Свайп влево по своему сообщению для входа в режим редактирования
   - Индикация режима редактирования
   - Отмена редактирования через кнопку закрытия
   - Автоматическое обновление сообщения после редактирования

4. **Поведение клавиатуры**
   - Автоматическая подстройка прокрутки при появлении клавиатуры
   - Жест касания для скрытия клавиатуры
   - Корректная обработка событий клавиатуры на разных платформах

5. **Обработка вложений**
   - Выпадающее меню для опций вложений
   - Заготовки для интеграции с камерой и галереей

## Техническая реализация

### Ключевые компоненты

1. **Модели**
   - `ChatMessage`: Основная структура данных сообщения с содержимым, ID отправителя, временной меткой
   - `Doctor`: Информация о медицинском работнике со статусом онлайн
   - `Appointment`: Для сообщений, связанных с приемами
   - Перечисления для типов сообщений и статусов приема

2. **Модель представления**
   - Наблюдаемые коллекции для обновлений в реальном времени
   - Команды для взаимодействия с пользователем (отправка, ответ, вложения)
   - Логика обработки и подготовки сообщений

3. **Конвертеры**
   - `MessageBackgroundConverter`: Обрабатывает визуальное оформление в зависимости от отправителя

4. **Поведения**
   - `KeyboardBehavior`: Управляет появлением клавиатуры и положением прокрутки

## Доступность и производительность

1. **Доступность**
   - Достаточный контраст для удобства чтения текста
   - Поддержка масштабирования системных шрифтов
   - Совместимость с экранными дикторами

2. **Оптимизации производительности**
   - Виртуализированный CollectionView для эффективного рендеринга сообщений
   - Правильное освобождение ресурсов в OnDisappearing
   - Обновления UI выполняются в основном потоке
   - Ограниченные обновления для плавной прокрутки

## Особенности платформ

Реализация учитывает особенности работы на разных платформах:

- Обработка обновлений коллекции в iOS
- Правильное применение эффектов тени с учетом особенностей платформы
- Различия в поведении клавиатуры между платформами

## Безопасность

- Сообщения планируется шифровать (В РАЗРАБОТКЕ)
- Отсутствие конфиденциальной информации в уведомлениях
- Безопасное хранение истории сообщений