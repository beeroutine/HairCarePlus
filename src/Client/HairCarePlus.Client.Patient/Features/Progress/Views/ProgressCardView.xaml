<?xml version="1.0" encoding="utf-8"?>
<ContentView x:Class="HairCarePlus.Client.Patient.Features.Progress.Views.ProgressCardView"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:HairCarePlus.Client.Patient.Features.Progress.Domain.Entities"
             xmlns:converters="clr-namespace:HairCarePlus.Client.Patient.Common.Converters"
             xmlns:conv="clr-namespace:HairCarePlus.Client.Patient.Features.Progress.Converters"
             xmlns:vm="clr-namespace:HairCarePlus.Client.Patient.Features.Progress.ViewModels"
             x:DataType="models:ProgressFeedItem">
    <ContentView.Resources>
        <ResourceDictionary>
            <converters:CountToBoolConverter x:Key="CountToBoolConverter" />
            <converters:ReadMoreVisibilityConverter x:Key="ReadMoreVisibilityConverter" Threshold="120" />
            <conv:NullToBoolConverter x:Key="NullToBoolConverter" />
            <conv:StringNullOrEmptyBoolConverter x:Key="StringNullOrEmptyBoolConverter" />
        </ResourceDictionary>
    </ContentView.Resources>

    <Border Style="{StaticResource PhotoCardStyle}">
        <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="12">
            <!-- Фото с минималистичной меткой дня -->
            <Border Grid.Row="0" 
                    StrokeShape="RoundRectangle 8" 
                    HeightRequest="160">
                <Grid>
                    <CarouselView ItemsSource="{Binding Photos}"
                                  IndicatorView="{x:Reference dots}"
                                  IsSwipeEnabled="True"
                                  PeekAreaInsets="0"
                                  IsVisible="{Binding Photos.Count, Converter={StaticResource CountToBoolConverter}}">
                        <CarouselView.ItemTemplate>
                            <DataTemplate x:DataType="models:ProgressPhoto">
                                <Image Source="{Binding LocalPath}"
                                       Aspect="AspectFill">
                                    <Image.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PreviewPhotoCommand}" CommandParameter="{Binding .}" />
                                    </Image.GestureRecognizers>
                                </Image>
                            </DataTemplate>
                        </CarouselView.ItemTemplate>
                    </CarouselView>
                    <!-- Минималистичная метка дня -->
                    <Border Padding="8,4"
                            BackgroundColor="{AppThemeBinding Light=#F0F0F0E6, Dark=#1E1E1EE6}"
                            StrokeShape="RoundRectangle 12"
                            HorizontalOptions="Start"
                            VerticalOptions="Start"
                            Margin="12">
                        <Label Text="{Binding Title}"
                               FontSize="13"
                               TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}" />
                    </Border>
                    <IndicatorView x:Name="dots"
                                   IndicatorColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                   SelectedIndicatorColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}"
                                   HorizontalOptions="Center"
                                   VerticalOptions="End"
                                   Margin="0,0,0,8"
                                   IsVisible="{Binding Photos.Count, Converter={StaticResource CountToBoolConverter}, ConverterParameter=1}" />
                </Grid>
            </Border>

            <!-- Дата и прогресс в одной строке -->
            <Grid Grid.Row="1" ColumnDefinitions="*,Auto">
                <Label Text="{Binding Date, StringFormat='{0:d MMMM yyyy}'}"
                       FontSize="13"
                       TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray400}}" />
                <!-- AI Score без эмодзи, минималистично -->
                <HorizontalStackLayout Grid.Column="1" Spacing="4" IsVisible="{Binding AiReport, Converter={StaticResource NullToBoolConverter}}">
                    <Label Text="Score"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray500}}" />
                    <Label Text="{Binding AiReport.Score}"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Primary}" />
                </HorizontalStackLayout>
            </Grid>

            <!-- Единый блок для комментариев -->
            <VerticalStackLayout Grid.Row="2" Spacing="4">
                <!-- Приоритет отдается комментарию врача -->
                <Label IsVisible="{Binding DoctorReportSummary, Converter={StaticResource StringNullOrEmptyBoolConverter}}">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="Врач: " 
                                  FontAttributes="Bold"
                                  FontSize="13"
                                  TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray400}}" />
                            <Span Text="{Binding DoctorReportSummary}"
                                  FontSize="13"
                                  TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray400}}" />
                        </FormattedString>
                    </Label.FormattedText>
                </Label>
                
                <!-- AI комментарий показывается если нет комментария врача -->
                <Label Text="{Binding AiReport.Summary}"
                       FontSize="13"
                       LineHeight="1.4"
                       TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray400}}"
                       MaxLines="2"
                       LineBreakMode="TailTruncation">
                    <Label.Triggers>
                        <DataTrigger TargetType="Label" Binding="{Binding DoctorReportSummary, Converter={StaticResource StringNullOrEmptyBoolConverter}}" Value="True">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                        <DataTrigger TargetType="Label" Binding="{Binding AiReport}" Value="{x:Null}">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </Label.Triggers>
                </Label>
            </VerticalStackLayout>
        </Grid>
    </Border>
</ContentView> 