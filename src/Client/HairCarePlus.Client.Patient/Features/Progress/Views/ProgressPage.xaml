<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="HairCarePlus.Client.Patient.Features.Progress.Views.ProgressPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:HairCarePlus.Client.Patient.Features.Progress.ViewModels"
    xmlns:models="clr-namespace:HairCarePlus.Client.Patient.Features.Progress.Domain.Entities"
    xmlns:selectors="clr-namespace:HairCarePlus.Client.Patient.Features.Progress.Selectors"
    xmlns:converters="clr-namespace:HairCarePlus.Client.Patient.Common.Converters"
    xmlns:conv="clr-namespace:HairCarePlus.Client.Patient.Features.Progress.Converters"
    x:DataType="vm:ProgressViewModel"
    Shell.NavBarIsVisible="True"
    Title="Progress"
    BackgroundColor="{AppThemeBinding Light=#F7F7F7, Dark=#1C1C1E}"
    x:Name="RootPage">

    <ContentPage.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Styles/ProgressStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <DataTemplate x:Key="StandardRestrictionTimerTemplate" x:DataType="models:RestrictionTimer">
                <VerticalStackLayout WidthRequest="70" HorizontalOptions="Center" Spacing="8">
                    <VerticalStackLayout.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.OpenRestrictionDetailsCommand}" CommandParameter="{Binding .}" />
                    </VerticalStackLayout.GestureRecognizers>
                    
                    <!-- ÐšÑ€ÑƒÐ¶Ð¾Ðº Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ Ñ‡Ð¸ÑÐ»Ð¾Ð¼ Ð´Ð½ÐµÐ¹ -->
                    <Border x:Name="RestrictionCircle"
                            Style="{StaticResource ModernRestrictionCircleStyle}"
                            AutomationProperties.IsInAccessibleTree="True"
                            AutomationProperties.Name="{Binding Title, Converter={StaticResource RestrictionShortPhraseConverter}}">
                        
                        <!-- Ð¦Ð²ÐµÑ‚Ð¾Ð²Ð°Ñ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾ ÑÑ€Ð¾Ñ‡Ð½Ð¾ÑÑ‚Ð¸ -->
                        <Border.Triggers>
                            <!-- Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ (0 Ð´Ð½ÐµÐ¹) -->
                            <DataTrigger TargetType="Border" Binding="{Binding DaysRemaining}" Value="0">
                                <Setter Property="Stroke" Value="{StaticResource CompletedRestrictionColor}" />
                                <Setter Property="BackgroundColor" Value="{StaticResource CompletedRestrictionBackground}" />
                                <Setter Property="Opacity" Value="0.7" />
                            </DataTrigger>
                            
                            <!-- ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ (1 Ð´ÐµÐ½ÑŒ) -->
                            <DataTrigger TargetType="Border" Binding="{Binding DaysRemaining}" Value="1">
                                <Setter Property="Stroke" Value="{StaticResource CriticalRestrictionColor}" />
                                <Setter Property="BackgroundColor" Value="{StaticResource CriticalRestrictionBackground}" />
                                <Setter Property="StrokeThickness" Value="3" />
                            </DataTrigger>
                            
                            <!-- Ð¡ÐºÐ¾Ñ€Ð¾ Ð¸ÑÑ‚ÐµÐºÐ°ÑŽÑ‰Ð¸Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ (2-3 Ð´Ð½Ñ) -->
                            <MultiTrigger TargetType="Border">
                                <MultiTrigger.Conditions>
                                    <BindingCondition Binding="{Binding DaysRemaining}" Value="2" />
                                </MultiTrigger.Conditions>
                                <Setter Property="Stroke" Value="{StaticResource SoonRestrictionColor}" />
                                <Setter Property="BackgroundColor" Value="{StaticResource SoonRestrictionBackground}" />
                                <Setter Property="StrokeThickness" Value="2.5" />
                            </MultiTrigger>
                            
                            <MultiTrigger TargetType="Border">
                                <MultiTrigger.Conditions>
                                    <BindingCondition Binding="{Binding DaysRemaining}" Value="3" />
                                </MultiTrigger.Conditions>
                                <Setter Property="Stroke" Value="{StaticResource SoonRestrictionColor}" />
                                <Setter Property="BackgroundColor" Value="{StaticResource SoonRestrictionBackground}" />
                                <Setter Property="StrokeThickness" Value="2.5" />
                            </MultiTrigger>
                        </Border.Triggers>
                        
                        <!-- Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ð¸ÑÐ»Ð¾ Ð´Ð½ÐµÐ¹ -->
                        <Label x:Name="DaysLabel"
                               Text="{Binding DaysRemaining}"
                               Style="{StaticResource RestrictionDaysTextStyle}">
                            <Label.Triggers>
                                <!-- Ð¡Ñ‚Ð¸Ð»Ð¸ Ñ‚ÐµÐºÑÑ‚Ð° Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÑÑ€Ð¾Ñ‡Ð½Ð¾ÑÑ‚Ð¸ -->
                                <DataTrigger TargetType="Label" Binding="{Binding DaysRemaining}" Value="0">
                                    <Setter Property="Text" Value="âœ“" />
                                    <Setter Property="TextColor" Value="{StaticResource CompletedRestrictionColor}" />
                                </DataTrigger>
                                <DataTrigger TargetType="Label" Binding="{Binding DaysRemaining}" Value="1">
                                    <Setter Property="TextColor" Value="{StaticResource CriticalRestrictionColor}" />
                                </DataTrigger>
                                <MultiTrigger TargetType="Label">
                                    <MultiTrigger.Conditions>
                                        <BindingCondition Binding="{Binding DaysRemaining}" Value="2" />
                                    </MultiTrigger.Conditions>
                                    <Setter Property="TextColor" Value="{StaticResource SoonRestrictionColor}" />
                                </MultiTrigger>
                                <MultiTrigger TargetType="Label">
                                    <MultiTrigger.Conditions>
                                        <BindingCondition Binding="{Binding DaysRemaining}" Value="3" />
                                    </MultiTrigger.Conditions>
                                    <Setter Property="TextColor" Value="{StaticResource SoonRestrictionColor}" />
                                </MultiTrigger>
                            </Label.Triggers>
                        </Label>
                        
                        <!-- VisualStateManager Ð´Ð»Ñ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ð¹ -->
                        <VisualStateManager.VisualStateGroups>
                            <VisualStateGroupList>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal" />
                                    <VisualState x:Name="Pressed">
                                        <VisualState.Setters>
                                            <Setter Property="Scale" Value="0.92" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                                
                                <!-- ÐŸÑƒÐ»ÑŒÑÐ°Ñ†Ð¸Ñ Ð´Ð»Ñ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ… Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ -->
                                <VisualStateGroup x:Name="UrgencyStates">
                                    <VisualState x:Name="Critical">
                                        <VisualState.StateTriggers>
                                            <StateTrigger IsActive="{Binding DaysRemaining, Converter={StaticResource EqualToConverter}, ConverterParameter=1}" />
                                        </VisualState.StateTriggers>
                                        <VisualState.Setters>
                                            <Setter Property="Scale" Value="1.05" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateGroupList>
                        </VisualStateManager.VisualStateGroups>
                    </Border>
                    
                    <!-- ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ°Ñ Ñ„Ñ€Ð°Ð·Ð° Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ -->
                    <Label Text="{Binding Title, Converter={StaticResource RestrictionShortPhraseConverter}}"
                           Style="{StaticResource RestrictionLabelStyle}"
                           AutomationProperties.IsInAccessibleTree="True"
                           AutomationProperties.Name="{Binding Title, Converter={StaticResource RestrictionShortPhraseConverter}}" />
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="ShowMoreRestrictionsTemplate" x:DataType="vm:ShowMoreRestrictionPlaceholderViewModel">
                <VerticalStackLayout WidthRequest="70" HorizontalOptions="Center" Spacing="8">
                    <Border Style="{StaticResource ShowMoreRestrictionCircleStyle}"
                            AutomationProperties.IsInAccessibleTree="True"
                            AutomationProperties.Name="Show more restrictions">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ShowAllRestrictionsCommand}" />
                        </Border.GestureRecognizers>
                        
                        <Label Text="{Binding CountLabel}" 
                               Style="{StaticResource ShowMoreTextStyle}" />
                        
                        <VisualStateManager.VisualStateGroups>
                            <VisualStateGroupList>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal" />
                                    <VisualState x:Name="Pressed">
                                        <VisualState.Setters>
                                            <Setter Property="Scale" Value="0.92" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateGroupList>
                        </VisualStateManager.VisualStateGroups>
                    </Border>
                    
                    <Label Text="Ð•Ñ‰Ðµ"
                           Style="{StaticResource RestrictionLabelStyle}" />
                </VerticalStackLayout>
            </DataTemplate>

            <selectors:RestrictionItemTemplateSelector x:Key="RestrictionItemTemplateSelector" 
                                                  StandardTemplate="{StaticResource StandardRestrictionTimerTemplate}" 
                                                  ShowMoreTemplate="{StaticResource ShowMoreRestrictionsTemplate}" />

            <!-- Converter to decide whether to display the "Read more" link -->
            <converters:ReadMoreVisibilityConverter x:Key="ReadMoreVisibilityConverter" Threshold="120" />
            <converters:CountToBoolConverter x:Key="CountToBoolConverter" />
            <conv:RestrictionStrokeColorConverter x:Key="RestrictionStrokeConverter" />
            <conv:RestrictionGlyphConverter x:Key="RestrictionGlyphConverter" />
            <conv:RestrictionFillColorConverter x:Key="RestrictionFillConverter" />
            <conv:RestrictionShortPhraseConverter x:Key="RestrictionShortPhraseConverter" />
            <conv:EqualToConverter x:Key="EqualToConverter" />

        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.Shell.TitleView>
        <!-- Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ð´Ð¸Ð·Ð°Ð¹Ð½Ð° -->
    </ContentPage.Shell.TitleView>

    <!-- Instagram-Ð¿Ð¾Ð´Ð¾Ð±Ð½Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ Ñ„Ð¾ÐºÑƒÑÐ¾Ð¼ Ð½Ð° Ð»ÐµÐ½Ñ‚Ðµ -->
    <Grid RowDefinitions="Auto,*" RowSpacing="20" Padding="0,16,0,0">
        
        <!-- ÐœÐ¾Ð´ÐµÑ€Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ñ‹ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ -->
        <ScrollView Grid.Row="0" 
                    Orientation="Horizontal" 
                    HorizontalScrollBarVisibility="Never"
                    Padding="16,0"
                    HeightRequest="90">
            <CollectionView ItemsSource="{Binding VisibleRestrictionItems}"
                            SelectionMode="None"
                            ItemTemplate="{StaticResource RestrictionItemTemplateSelector}">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Horizontal" ItemSpacing="16" />
                </CollectionView.ItemsLayout>
            </CollectionView>
        </ScrollView>

        <!-- Instagram-Ð¿Ð¾Ð´Ð¾Ð±Ð½Ð°Ñ Ð»ÐµÐ½Ñ‚Ð° Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ° -->
        <RefreshView Grid.Row="1"
                     Command="{Binding LoadCommand}"
                     IsRefreshing="{Binding IsRefreshing, Mode=TwoWay}"
                     Margin="0">
            <CollectionView ItemsSource="{Binding Feed}"
                            SelectionMode="None"
                            HorizontalScrollBarVisibility="Never"
                            VerticalScrollBarVisibility="Never"
                            Margin="0">
                <CollectionView.EmptyView>
                    <StackLayout HorizontalOptions="Center" 
                                VerticalOptions="CenterAndExpand" 
                                Padding="32"
                                Spacing="12">
                        <Label Text="ðŸ“¸" 
                               FontSize="32"
                               HorizontalOptions="Center" />
                        <Label Text="ÐÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°" 
                               FontSize="16" 
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray800}, Dark={StaticResource Gray300}}" />
                        <Label Text="ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ²Ð¾Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ&#x0a;Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ" 
                               FontSize="14" 
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray500}}" />
                    </StackLayout>
                </CollectionView.EmptyView>
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="8" />
                </CollectionView.ItemsLayout>
                                 <CollectionView.ItemTemplate>
                     <DataTemplate x:DataType="models:ProgressFeedItem">
                         <views:ProgressCardView xmlns:views="clr-namespace:HairCarePlus.Client.Patient.Features.Progress.Views" />
                     </DataTemplate>
                 </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
    </Grid>
    <!-- FAB removed as per design -->
</ContentPage> 