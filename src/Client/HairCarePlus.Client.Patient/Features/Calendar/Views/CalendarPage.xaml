<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:HairCarePlus.Client.Patient.Features.Calendar.Views"
             xmlns:viewmodels="clr-namespace:HairCarePlus.Client.Patient.Features.Calendar.ViewModels"
             xmlns:helpers="clr-namespace:HairCarePlus.Client.Patient.Features.Calendar.Helpers"
             x:Class="HairCarePlus.Client.Patient.Features.Calendar.Views.CalendarPage"
             Title="{Binding Title}">
    
    <ContentPage.Resources>
        <ResourceDictionary>
            <helpers:HasItemsConverter x:Key="HasItemsConverter" />
            <helpers:EventTypeToColorConverter x:Key="EventTypeToColorConverter" />
            <helpers:EventTypeToBackgroundConverter x:Key="EventTypeToBackgroundConverter" />
            <helpers:IsNotRestrictionConverter x:Key="IsNotRestrictionConverter" />
            <helpers:IsRestrictionConverter x:Key="IsRestrictionConverter" />
            <helpers:EventTypeToLabelConverter x:Key="EventTypeToLabelConverter" />
            
            <Style x:Key="EventTitleStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource TextPrimaryColor}, Dark={StaticResource White}}" />
            </Style>
            
            <Style x:Key="EventDescriptionStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource TextSecondaryColor}, Dark={StaticResource Gray300}}" />
            </Style>
            
            <Style x:Key="EventTimeStyle" TargetType="Label">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource TextSecondaryColor}, Dark={StaticResource Gray300}}" />
            </Style>
            
            <Style x:Key="EventCardStyle" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource BackgroundColor}, Dark={StaticResource Gray900}}" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="Padding" Value="16" />
                <Setter Property="Margin" Value="0,6" />
                <Setter Property="BorderColor" Value="{AppThemeBinding Light={StaticResource BorderColor}, Dark={StaticResource Gray600}}" />
                <Setter Property="HasShadow" Value="False" />
            </Style>

            <Style x:Key="ErrorMessageStyle" TargetType="Label">
                <Setter Property="TextColor" Value="{StaticResource ErrorColor}" />
                <Setter Property="FontSize" Value="14" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="Margin" Value="16" />
            </Style>

            <Style x:Key="SubheaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="18" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource TextPrimaryColor}, Dark={StaticResource White}}" />
                <Setter Property="Margin" Value="0,0,0,8" />
            </Style>
            
            <Style x:Key="DateHeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="20" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrimaryColor}, Dark={StaticResource PrimaryDark}}" />
                <Setter Property="Margin" Value="0,0,0,8" />
            </Style>
            
            <Style x:Key="NoEventsStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource TextSecondaryColor}, Dark={StaticResource Gray300}}" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="VerticalOptions" Value="Center" />
                <Setter Property="Margin" Value="0,16" />
            </Style>
            
            <Style x:Key="EventTypeBadgeStyle" TargetType="Border">
                <Setter Property="Padding" Value="6,2" />
                <Setter Property="StrokeThickness" Value="0" />
                <Setter Property="StrokeShape" Value="RoundRectangle 10,10,10,10" />
                <Setter Property="HorizontalOptions" Value="Start" />
                <Setter Property="Margin" Value="0,0,0,6" />
            </Style>
            
            <Style x:Key="EventTypeLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="11" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="White" />
            </Style>
            
            <Style x:Key="DateRangeStyle" TargetType="Label">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource TextSecondaryColor}, Dark={StaticResource Gray300}}" />
                <Setter Property="Margin" Value="0,4,0,0" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>
    
    <Grid>
        <!-- Main Content -->
        <RefreshView IsRefreshing="{Binding IsBusy}"
                     Command="{Binding RefreshCommand}">
            <ScrollView>
                <StackLayout Padding="16" Spacing="16">
                    <!-- Error Message -->
                    <Label Text="{Binding ErrorMessage}"
                           Style="{StaticResource ErrorMessageStyle}"
                           IsVisible="{Binding HasError}" />
                    
                    <!-- Monthly Calendar -->
                    <Frame Style="{StaticResource CardStyle}" 
                           Padding="2" 
                           Margin="0,8" 
                           HasShadow="True"
                           BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundColor}, Dark={StaticResource Gray900}}"
                           BorderColor="{AppThemeBinding Light={StaticResource BorderColor}, Dark={StaticResource Gray600}}">
                        <views:MonthCalendarView BindingContext="{Binding .}" VerticalOptions="Start" />
                    </Frame>
                    
                    <!-- Combined Day Information Section -->
                    <Frame Style="{StaticResource CardStyle}" 
                           BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundColor}, Dark={StaticResource Gray900}}"
                           BorderColor="{AppThemeBinding Light={StaticResource BorderColor}, Dark={StaticResource Gray600}}"
                           Margin="0,8">
                        <StackLayout Spacing="12">
                            <!-- Day Header -->
                            <Label Text="{Binding SelectedDate, StringFormat='{0:MMMM d, yyyy}'}"
                                   Style="{StaticResource DateHeaderStyle}" />
                            
                            <!-- All Events List (including restrictions) -->
                            <CollectionView ItemsSource="{Binding EventsForSelectedDate}" 
                                          SelectionMode="None"
                                          EmptyView="No events or restrictions for this day"
                                          HeightRequest="240">
                                <CollectionView.EmptyViewTemplate>
                                    <DataTemplate>
                                        <Label Text="No events or restrictions for this day" 
                                               Style="{StaticResource NoEventsStyle}" />
                                    </DataTemplate>
                                </CollectionView.EmptyViewTemplate>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Frame Style="{StaticResource EventCardStyle}"
                                               BackgroundColor="{Binding EventType, Converter={StaticResource EventTypeToBackgroundConverter}}"
                                               Margin="0,4">
                                            <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="Auto,*,Auto">
                                                <!-- Event type indicator -->
                                                <BoxView Grid.Row="0" Grid.RowSpan="4" Grid.Column="0"
                                                         WidthRequest="6"
                                                         VerticalOptions="Fill"
                                                         Margin="0,0,12,0"
                                                         BackgroundColor="{Binding EventType, Converter={StaticResource EventTypeToColorConverter}}" />
                                                 
                                                <!-- Event type badge -->
                                                <Border Grid.Row="0" Grid.Column="1"
                                                        BackgroundColor="{Binding EventType, Converter={StaticResource EventTypeToColorConverter}}"
                                                        Style="{StaticResource EventTypeBadgeStyle}">
                                                    <Label Text="{Binding EventType, Converter={StaticResource EventTypeToLabelConverter}}"
                                                           Style="{StaticResource EventTypeLabelStyle}" />
                                                </Border>
                                                
                                                <!-- Event title -->
                                                <Label Grid.Row="1" Grid.Column="1"
                                                       Text="{Binding Title}"
                                                       FontAttributes="Bold"
                                                       TextColor="{AppThemeBinding Light={StaticResource TextPrimaryColor}, Dark={StaticResource White}}"
                                                       Margin="0,0,0,4" />
                                                   
                                                <!-- Event description -->
                                                <Label Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2"
                                                       Text="{Binding Description}"
                                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondaryColor}, Dark={StaticResource Gray300}}"
                                                       LineBreakMode="WordWrap" />
                                                
                                                <!-- Date range for restrictions -->
                                                <Label Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="2"
                                                       IsVisible="{Binding EventType, Converter={StaticResource IsRestrictionConverter}}"
                                                       Text="{Binding ExpirationDate, StringFormat='Until {0:MMM dd, yyyy}'}"
                                                       Style="{StaticResource DateRangeStyle}" />
                                                   
                                                <!-- Completion checkbox -->
                                                <CheckBox Grid.Row="1" Grid.Column="2"
                                                          IsChecked="{Binding IsCompleted}"
                                                          CheckedChanged="OnEventCheckedChanged"
                                                          Color="{StaticResource CheckBoxColor}"
                                                          IsVisible="{Binding EventType, Converter={StaticResource IsNotRestrictionConverter}}"/>
                                            </Grid>
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </StackLayout>
                    </Frame>
                </StackLayout>
            </ScrollView>
        </RefreshView>
    </Grid>
</ContentPage> 