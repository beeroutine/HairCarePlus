<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:HairCarePlus.Client.Patient.Features.Calendar.Views"
             xmlns:helpers="clr-namespace:HairCarePlus.Client.Patient.Features.Calendar.Helpers"
             xmlns:models="clr-namespace:HairCarePlus.Client.Patient.Features.Calendar.Models"
             x:Class="HairCarePlus.Client.Patient.Features.Calendar.Views.CalendarPage"
             Title="Календарь">
    
    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Конвертеры -->
            <helpers:BooleanInvertConverter x:Key="BoolInvertConverter" />
            
            <!-- Минимально необходимые стили -->
            <Style x:Key="BasicLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="TextColor" Value="Black" />
            </Style>
            
            <Style x:Key="HeaderLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="20" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="Black" />
                <Setter Property="HorizontalOptions" Value="Center" />
            </Style>
            
            <Style x:Key="BasicButtonStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="#6200EE" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="Margin" Value="5" />
                <Setter Property="CornerRadius" Value="5" />
            </Style>
            
            <!-- Стили для дней календаря - разделены по типам -->
            <Style x:Key="CalendarDayButtonStyle" TargetType="Button">
                <Setter Property="WidthRequest" Value="40" />
                <Setter Property="HeightRequest" Value="40" />
                <Setter Property="FontSize" Value="14" />
                <Setter Property="Background" Value="Transparent" />
                <Setter Property="BorderColor" Value="Transparent" />
                <Setter Property="BorderWidth" Value="0" />
                <Setter Property="TextColor" Value="Black" />
                <Setter Property="Margin" Value="2" />
            </Style>
            
            <Style x:Key="CalendarDayLabelStyle" TargetType="Label">
                <Setter Property="WidthRequest" Value="40" />
                <Setter Property="HeightRequest" Value="40" />
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TextColor" Value="Black" />
                <Setter Property="Margin" Value="2" />
                <Setter Property="HorizontalTextAlignment" Value="Center" />
                <Setter Property="VerticalTextAlignment" Value="Center" />
            </Style>
            
            <Style x:Key="CalendarDayOfWeekStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TextColor" Value="#666666" />
                <Setter Property="HorizontalOptions" Value="Center" />
            </Style>

            <!-- Стиль для текущего дня -->
            <Style x:Key="CurrentDayButtonStyle" TargetType="Button" BasedOn="{StaticResource CalendarDayButtonStyle}">
                <Setter Property="TextColor" Value="#6200EE" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="BorderColor" Value="#6200EE" />
                <Setter Property="BorderWidth" Value="1" />
                <Setter Property="CornerRadius" Value="20" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Заголовок с названием текущего месяца -->
        <Grid Grid.Row="0" 
              ColumnDefinitions="Auto,*,Auto" 
              Padding="10" 
              BackgroundColor="#F5F5F5">
            
            <Button Grid.Column="0" 
                    Text="&lt;" 
                    Command="{Binding PreviousMonthCommand}"
                    Style="{StaticResource BasicButtonStyle}" />
            
            <Label Grid.Column="1" 
                   Text="{Binding CurrentMonthYear}" 
                   Style="{StaticResource HeaderLabelStyle}" 
                   VerticalOptions="Center" />
            
            <Button Grid.Column="2" 
                    Text="&gt;" 
                    Command="{Binding NextMonthCommand}"
                    Style="{StaticResource BasicButtonStyle}" />
        </Grid>
        
        <!-- Основное содержимое -->
        <VerticalStackLayout Grid.Row="1" Padding="10" Spacing="10">
            <!-- Показываем когда IsMonthViewVisible = false -->
            <VerticalStackLayout IsVisible="{Binding IsMonthViewVisible, Converter={StaticResource BoolInvertConverter}}">
                <Label Text="{Binding SelectedDateText}" 
                       Style="{StaticResource HeaderLabelStyle}" />
                
                <Label Text="События на этот день:" 
                       Style="{StaticResource BasicLabelStyle}" 
                       Margin="0,10,0,5" />
                
                <Label Text="Нет событий на выбранный день" 
                       IsVisible="{Binding HasSelectedDayEvents, Converter={StaticResource BoolInvertConverter}}"
                       Style="{StaticResource BasicLabelStyle}" 
                       Opacity="0.7" />
                
                <!-- Список событий на выбранный день -->
                <CollectionView ItemsSource="{Binding SelectedDayEvents}"
                                IsVisible="{Binding HasSelectedDayEvents}"
                                Margin="0,5,0,10">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:CalendarEvent">
                            <Frame Margin="0,5" Padding="10" BorderColor="#E0E0E0">
                                <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto">
                                    <!-- Индикатор типа события -->
                                    <BoxView Grid.RowSpan="3" 
                                             WidthRequest="4" 
                                             BackgroundColor="#6200EE" 
                                             Margin="0,0,10,0" />
                                    
                                    <!-- Название события -->
                                    <Label Grid.Column="1" 
                                           Grid.Row="0" 
                                           Text="{Binding Title}" 
                                           FontSize="16" 
                                           FontAttributes="Bold" />
                                    
                                    <!-- Описание события -->
                                    <Label Grid.Column="1" 
                                           Grid.Row="1" 
                                           Text="{Binding Description}" 
                                           FontSize="14" 
                                           Margin="0,5,0,5" />
                                    
                                    <!-- Время события (если есть) -->
                                    <Label Grid.Column="1" 
                                           Grid.Row="2" 
                                           Text="08:00" 
                                           FontSize="12" 
                                           TextColor="#666666" />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
                <Button Text="Вернуться к месяцу" 
                        Command="{Binding BackToMonthViewCommand}"
                        Style="{StaticResource BasicButtonStyle}" 
                        Margin="0,10,0,0" />
            </VerticalStackLayout>
            
            <!-- Показываем когда IsMonthViewVisible = true - вид календаря -->
            <VerticalStackLayout IsVisible="{Binding IsMonthViewVisible}" Spacing="5">
                <!-- Дни недели -->
                <Grid ColumnDefinitions="*,*,*,*,*,*,*">
                    <Label Grid.Column="0" Text="ПН" Style="{StaticResource CalendarDayOfWeekStyle}" />
                    <Label Grid.Column="1" Text="ВТ" Style="{StaticResource CalendarDayOfWeekStyle}" />
                    <Label Grid.Column="2" Text="СР" Style="{StaticResource CalendarDayOfWeekStyle}" />
                    <Label Grid.Column="3" Text="ЧТ" Style="{StaticResource CalendarDayOfWeekStyle}" />
                    <Label Grid.Column="4" Text="ПТ" Style="{StaticResource CalendarDayOfWeekStyle}" />
                    <Label Grid.Column="5" Text="СБ" Style="{StaticResource CalendarDayOfWeekStyle}" />
                    <Label Grid.Column="6" Text="ВС" Style="{StaticResource CalendarDayOfWeekStyle}" />
                </Grid>
                
                <!-- Динамическая сетка календаря -->
                <Grid x:Name="CalendarGrid" 
                      ColumnDefinitions="*,*,*,*,*,*,*" 
                      RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" 
                      Margin="0,5,0,0">
                    <!-- Сетка будет заполнена программно в CalendarPage.xaml.cs -->
                </Grid>
                
                <!-- Кнопка перехода к текущей дате -->
                <Button Text="Перейти к сегодня" 
                        Command="{Binding GoToTodayCommand}"
                        Style="{StaticResource BasicButtonStyle}" 
                        HorizontalOptions="Center" 
                        Margin="0,10,0,0" />
            </VerticalStackLayout>
        </VerticalStackLayout>
        
        <!-- Кнопка для отладки -->
        <Button Grid.Row="2"
                Text="Диагностика" 
                Clicked="DiagnosticButton_Clicked"
                Style="{StaticResource BasicButtonStyle}"
                HorizontalOptions="Center" 
                Margin="0,10,0,10" />
    </Grid>
</ContentPage> 