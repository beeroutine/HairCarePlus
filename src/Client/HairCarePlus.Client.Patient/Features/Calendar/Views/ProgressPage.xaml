<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:HairCarePlus.Client.Patient.Features.Calendar.ViewModels"
             x:Class="HairCarePlus.Client.Patient.Features.Calendar.Views.ProgressPage"
             x:DataType="viewmodels:ProgressViewModel"
             Title="Прогресс восстановления"
             BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray950}}">

    <Grid RowDefinitions="Auto,*">
        <!-- Overall Progress -->
        <Frame Grid.Row="0" 
               Margin="15,15,15,5" 
               Padding="15" 
               BorderColor="Transparent"
               BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
               CornerRadius="15"
               HasShadow="True">
            <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="Auto,*,Auto">
                <!-- Phase Icon -->
                <Frame Grid.Row="0" 
                       Grid.RowSpan="3" 
                       Grid.Column="0"
                       HeightRequest="60" 
                       WidthRequest="60"
                       CornerRadius="30"
                       Padding="0"
                       Margin="0,0,15,0"
                       BorderColor="Transparent"
                       BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                       VerticalOptions="Center">
                    <Label Text="&#xf201;" 
                           FontFamily="FontAwesome"
                           FontSize="24"
                           TextColor="{StaticResource Primary}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Frame>
                
                <!-- Phase Text -->
                <Label Grid.Row="0" 
                       Grid.Column="1"
                       Text="{Binding CurrentPhaseText}" 
                       FontSize="18" 
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"/>
                
                <!-- Progress Text -->
                <Label Grid.Row="1" 
                       Grid.Column="1"
                       Text="{Binding ProgressText}" 
                       FontSize="14"
                       TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"/>
                
                <!-- Progress Bar -->
                <ProgressBar Grid.Row="2" 
                             Grid.Column="1"
                             Progress="{Binding ProgressPercentage}" 
                             ProgressColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
                             HeightRequest="8"
                             Margin="0,5,0,0"/>
                
                <!-- Percentage -->
                <Label Grid.Row="0" 
                       Grid.RowSpan="3"
                       Grid.Column="2"
                       Text="{Binding ProgressPercentage, StringFormat='{0:P0}'}" 
                       FontSize="20" 
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
                       VerticalOptions="Center"/>
            </Grid>
        </Frame>

        <!-- Content -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="15" Padding="15">
                <!-- Phase Progress -->
                <Frame BorderColor="Transparent" 
                       Padding="0" 
                       BackgroundColor="Transparent">
                    <VerticalStackLayout Spacing="10">
                        <Grid ColumnDefinitions="Auto,*">
                            <Frame HeightRequest="40" 
                                   WidthRequest="40"
                                   CornerRadius="20"
                                   Padding="0"
                                   Margin="0,0,10,0"
                                   BorderColor="Transparent"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                   VerticalOptions="Center">
                                <Label Text="&#xf0cb;" 
                                       FontFamily="FontAwesome"
                                       FontSize="18"
                                       TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Frame>
                            <Label Text="Фазы восстановления" 
                                   FontSize="20" 
                                   FontAttributes="Bold"
                                   Grid.Column="1"
                                   VerticalOptions="Center"/>
                        </Grid>
                        
                        <CollectionView ItemsSource="{Binding Phases}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="viewmodels:PhaseViewModel">
                                    <Frame Margin="0,5" 
                                           Padding="15" 
                                           BorderColor="Transparent"
                                           BackgroundColor="{Binding IsActive, Converter={StaticResource BoolToBackgroundConverter}}"
                                           CornerRadius="10"
                                           HasShadow="True">
                                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto">
                                            <Label Text="{Binding Name}" 
                                                   FontAttributes="Bold"
                                                   FontSize="16"
                                                   Grid.ColumnSpan="2"/>
                                            <Label Text="{Binding Description}" 
                                                   Grid.Row="1"/>
                                            <Label Text="{Binding Status}" 
                                                   Grid.Row="1" 
                                                   Grid.Column="1"
                                                   TextColor="{Binding IsCompleted, Converter={StaticResource BoolToColorConverter}}"/>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <!-- Expected Changes -->
                <Frame BorderColor="Transparent" 
                       Padding="0" 
                       BackgroundColor="Transparent">
                    <VerticalStackLayout Spacing="10">
                        <Grid ColumnDefinitions="Auto,*">
                            <Frame HeightRequest="40" 
                                   WidthRequest="40"
                                   CornerRadius="20"
                                   Padding="0"
                                   Margin="0,0,10,0"
                                   BorderColor="Transparent"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                   VerticalOptions="Center">
                                <Label Text="&#xf0d0;" 
                                       FontFamily="FontAwesome"
                                       FontSize="18"
                                       TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Frame>
                            <Label Text="Ожидаемые изменения" 
                                   FontSize="20" 
                                   FontAttributes="Bold"
                                   Grid.Column="1"
                                   VerticalOptions="Center"/>
                        </Grid>
                        
                        <CollectionView ItemsSource="{Binding ExpectedChanges}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="viewmodels:ExpectedChangeViewModel">
                                    <Frame Margin="0,5" 
                                           Padding="15" 
                                           BorderColor="Transparent"
                                           BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                           CornerRadius="10"
                                           HasShadow="True">
                                        <VerticalStackLayout>
                                            <Label Text="{Binding Name}" 
                                                   FontAttributes="Bold"
                                                   FontSize="16"/>
                                            <Label Text="{Binding Description}"/>
                                        </VerticalStackLayout>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <!-- Milestones -->
                <Frame BorderColor="Transparent" 
                       Padding="0" 
                       BackgroundColor="Transparent">
                    <VerticalStackLayout Spacing="10">
                        <Grid ColumnDefinitions="Auto,*">
                            <Frame HeightRequest="40" 
                                   WidthRequest="40"
                                   CornerRadius="20"
                                   Padding="0"
                                   Margin="0,0,10,0"
                                   BorderColor="Transparent"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                   VerticalOptions="Center">
                                <Label Text="&#xf091;" 
                                       FontFamily="FontAwesome"
                                       FontSize="18"
                                       TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Frame>
                            <Label Text="Важные этапы" 
                                   FontSize="20" 
                                   FontAttributes="Bold"
                                   Grid.Column="1"
                                   VerticalOptions="Center"/>
                        </Grid>
                        
                        <CollectionView ItemsSource="{Binding Milestones}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="viewmodels:MilestoneViewModel">
                                    <Frame Margin="0,5" 
                                           Padding="15" 
                                           BorderColor="Transparent"
                                           BackgroundColor="{Binding IsCompleted, Converter={StaticResource BoolToBackgroundConverter}}"
                                           CornerRadius="10"
                                           HasShadow="True">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <Frame HeightRequest="40" 
                                                   WidthRequest="40"
                                                   CornerRadius="20"
                                                   Padding="0"
                                                   Margin="0,0,10,0"
                                                   BorderColor="Transparent"
                                                   BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                                   VerticalOptions="Center">
                                                <Label Text="{Binding DayNumber}" 
                                                       FontSize="16" 
                                                       TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center"/>
                                            </Frame>
                                            <VerticalStackLayout Grid.Column="1">
                                                <Label Text="{Binding Name}" 
                                                       FontAttributes="Bold"
                                                       FontSize="16"/>
                                                <Label Text="{Binding Description}" 
                                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
                                                <CollectionView ItemsSource="{Binding UnlockedActivities}"
                                                              IsVisible="{Binding IsCompleted}">
                                                    <CollectionView.ItemTemplate>
                                                        <DataTemplate>
                                                            <Grid ColumnDefinitions="Auto,*" Margin="0,5">
                                                                <Label Text="✓" 
                                                                       TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                                                       Margin="0,0,5,0"/>
                                                                <Label Text="{Binding .}" 
                                                                       TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                                                       Grid.Column="1"/>
                                                            </Grid>
                                                        </DataTemplate>
                                                    </CollectionView.ItemTemplate>
                                                </CollectionView>
                                            </VerticalStackLayout>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage> 