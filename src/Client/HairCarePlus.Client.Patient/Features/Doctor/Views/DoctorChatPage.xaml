<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:HairCarePlus.Client.Patient.Features.Doctor.Models"
             xmlns:converters="clr-namespace:HairCarePlus.Client.Patient.Features.Doctor.Converters"
             xmlns:effects="clr-namespace:HairCarePlus.Client.Patient.Effects"
             x:Class="HairCarePlus.Client.Patient.Features.Doctor.Views.DoctorChatPage"
             BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Black}}"
             Shell.TabBarIsVisible="False"
             Padding="0"
             NavigationPage.HasNavigationBar="False">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:MessageBackgroundConverter x:Key="MessageBackgroundConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Shell.TitleView>
        <Grid ColumnDefinitions="80,*,80">
            <Button Text="←"
                    Command="{Binding BackCommand}"
                    HorizontalOptions="Start"
                    FontSize="20"
                    TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                    BackgroundColor="Transparent"
                    Shadow="{OnPlatform iOS={StaticResource SmallShadow}}"
                    Margin="0"
                    Padding="0"
                    HeightRequest="44"
                    WidthRequest="44" />
            
            <Label Grid.Column="1"
                   Text="{Binding Doctor.Name}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                   FontSize="17"
                   FontAttributes="Bold" />
            
            <Label Grid.Column="2"
                   Text="{Binding Doctor.IsOnline, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Online,Offline'}"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                   HorizontalOptions="End"
                   VerticalOptions="Center"
                   Margin="0,0,16,0"
                   FontSize="15" />
        </Grid>
    </Shell.TitleView>

    <Grid RowDefinitions="Auto,*,Auto" 
          IgnoreSafeArea="True">
        <!-- Header -->
        <BoxView Grid.Row="0"
                 HeightRequest="1"
                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}" />

        <!-- Messages Background -->
        <Grid Grid.Row="1"
              BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}">
            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="{AppThemeBinding Light=#FFFFFF, Dark=#111827}"
                                Offset="0.0" />
                    <GradientStop Color="{AppThemeBinding Light=#F8FAFC, Dark=#0F172A}"
                                Offset="1.0" />
                </LinearGradientBrush>
            </Grid.Background>
        </Grid>

        <!-- Messages -->
        <CollectionView Grid.Row="1" 
                       ItemsSource="{Binding Messages}"
                       ItemsUpdatingScrollMode="KeepLastItemInView"
                       Margin="8,8,8,0">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ChatMessage">
                    <Grid Padding="4,2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Message -->
                        <Frame Grid.Column="{Binding SenderId, Converter={StaticResource MessageBackgroundConverter}, ConverterParameter='column'}"
                               Padding="12,8"
                               HasShadow="True"
                               Shadow="{OnPlatform iOS={StaticResource SmallShadow}}"
                               BorderColor="Transparent"
                               MaximumWidthRequest="280"
                               CornerRadius="18"
                               BackgroundColor="{Binding SenderId, Mode=OneWay}"
                               HorizontalOptions="{Binding SenderId, Converter={StaticResource MessageBackgroundConverter}, ConverterParameter='alignment'}"
                               Margin="{Binding SenderId, Converter={StaticResource MessageBackgroundConverter}, ConverterParameter='margin'}">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ReplyToMessageCommand}"
                                                    CommandParameter="{Binding .}" />
                            </Frame.GestureRecognizers>
                            <Frame.Triggers>
                                <DataTrigger TargetType="Frame"
                                           Binding="{Binding SenderId}"
                                           Value="patient">
                                    <Setter Property="BackgroundColor"
                                            Value="{AppThemeBinding Light=#ECFDF5, Dark=#3B82F6}" />
                                </DataTrigger>
                                <DataTrigger TargetType="Frame"
                                           Binding="{Binding SenderId}"
                                           Value="doctor">
                                    <Setter Property="BackgroundColor"
                                            Value="{AppThemeBinding Light=#D1FAE5, Dark=#1D4ED8}" />
                                </DataTrigger>
                            </Frame.Triggers>
                            <VerticalStackLayout Spacing="2">
                                <!-- Reply Preview -->
                                <Frame IsVisible="{Binding ReplyTo, Converter={StaticResource IsNotNullConverter}}"
                                      Padding="8,4"
                                      Margin="0,0,0,4"
                                      CornerRadius="8"
                                      BackgroundColor="{AppThemeBinding Light=#D1FAE5, Dark=#1D4ED8}"
                                      Opacity="0.9">
                                    <VerticalStackLayout Spacing="2">
                                        <Label Text="{Binding ReplyTo.SenderId, StringFormat='Reply to {0}'}"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                               FontSize="12">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label"
                                                           Binding="{Binding ReplyTo.SenderId}"
                                                           Value="patient">
                                                    <Setter Property="Text" Value="Reply to you"/>
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>
                                        <Label Text="{Binding ReplyTo.Content}"
                                               TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                                               FontSize="13"
                                               MaxLines="2"
                                               LineBreakMode="TailTruncation"/>
                                    </VerticalStackLayout>
                                </Frame>

                                <Label Text="{Binding Content}" 
                                       TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                                       FontSize="15"
                                       Margin="0,4,0,0"
                                       LineBreakMode="WordWrap"
                                       LineHeight="1.25"
                                       VerticalOptions="Center"/>
                                <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                       FontSize="11"
                                       Opacity="0.8"
                                       HorizontalOptions="End"/>
                            </VerticalStackLayout>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Reply Preview -->
        <Grid Grid.Row="2" 
              RowDefinitions="Auto,1,Auto"
              BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark=#1C1C1E}">
            <Grid.Padding>
                <OnPlatform x:TypeArguments="Thickness">
                    <On Platform="iOS" Value="0,0,0,30"/>
                    <On Platform="Default" Value="0"/>
                </OnPlatform>
            </Grid.Padding>
            
            <Frame Grid.Row="0"
                   IsVisible="{Binding ReplyToMessage, Converter={StaticResource IsNotNullConverter}}"
                   Padding="12,8"
                   Margin="8,4"
                   BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark=#2C2C2E}">
                <Grid ColumnDefinitions="*,Auto">
                    <VerticalStackLayout Spacing="2">
                        <Label Text="{Binding ReplyToMessage.SenderId, StringFormat='Reply to {0}'}"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                               FontSize="13"/>
                        <Label Text="{Binding ReplyToMessage.Content}"
                               TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                               FontSize="14"
                               MaxLines="1"
                               LineBreakMode="TailTruncation"/>
                    </VerticalStackLayout>
                    <Button Grid.Column="1"
                            Text="×"
                            Command="{Binding CancelReplyCommand}"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                            FontSize="20"
                            Padding="0"
                            HeightRequest="32"
                            WidthRequest="32"
                            VerticalOptions="Start"
                            HorizontalOptions="End"/>
                </Grid>
            </Frame>

            <BoxView Grid.Row="1"
                     HeightRequest="1"
                     Color="{AppThemeBinding Light={StaticResource Gray200}, Dark=#3A3A3C}" />

            <!-- Input Panel -->
            <Grid Grid.Row="2"
                  ColumnDefinitions="44,*,44"
                  MinimumHeightRequest="50"
                  Padding="8,6,8,8"
                  BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark=#1C1C1E}">

                <!-- Camera Button -->
                <Button Grid.Column="0"
                       Text="＋"
                       Command="{Binding OpenCameraCommand}"
                       BackgroundColor="Transparent"
                       TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                       Shadow="{OnPlatform iOS={StaticResource SmallShadow}}"
                       FontSize="24"
                       Padding="0"
                       Margin="0"
                       HeightRequest="38"
                       WidthRequest="38"
                       VerticalOptions="Start"/>

                <!-- Message Input -->
                <Frame Grid.Column="1"
                       BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                       Padding="8,0"
                       CornerRadius="18"
                       HasShadow="True"
                       Shadow="{OnPlatform iOS={StaticResource SmallShadow}}"
                       BorderColor="Transparent"
                       Margin="4,0,4,0"
                       MinimumHeightRequest="38"
                       MaximumHeightRequest="120"
                       VerticalOptions="Start">
                    <Editor Text="{Binding MessageText}" 
                           Placeholder="Message"
                           PlaceholderColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                           TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                           BackgroundColor="Transparent"
                           FontSize="17"
                           AutoSize="TextChanges"
                           MaxLength="1000"
                           Keyboard="Chat"
                           VerticalTextAlignment="Center"
                           Margin="0,-2,0,-2"/>
                </Frame>

                <!-- Send Button -->
                <Button Grid.Column="2"
                       IsVisible="{Binding MessageText, Converter={StaticResource StringNotEmptyConverter}}"
                       Text="↑"
                       Command="{Binding SendMessageCommand}"
                       BackgroundColor="Transparent"
                       TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                       Shadow="{OnPlatform iOS={StaticResource SmallShadow}}"
                       FontSize="20"
                       Padding="0"
                       Margin="0"
                       HeightRequest="38"
                       WidthRequest="38"
                       VerticalOptions="Start"/>
            </Grid>
        </Grid>
    </Grid>
</ContentPage> 