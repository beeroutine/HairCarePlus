<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:HairCarePlus.Client.Patient.Features.Doctor.Models"
             xmlns:converters="clr-namespace:HairCarePlus.Client.Patient.Features.Doctor.Converters"
             x:Class="HairCarePlus.Client.Patient.Features.Doctor.Views.DoctorChatPage"
             Title="{Binding Doctor.Name}"
             BackgroundColor="{StaticResource ChatBackgroundColor}">

    <ContentPage.Resources>
        <ResourceDictionary Source="/Resources/Styles/ChatStyles.xaml" />
        <converters:MessageBackgroundConverter x:Key="MessageBackgroundConverter" />
        <Color x:Key="OutgoingMessageColor">#E3FCD9</Color>
        <Color x:Key="IncomingMessageColor">#FFFFFF</Color>
        <Color x:Key="ChatBackgroundColor">#E4E9EF</Color>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto" x:Name="MainGrid">
        <Grid.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding DismissKeyboardCommand}" />
        </Grid.GestureRecognizers>
        <!-- Doctor Info -->
        <Border Grid.Row="0" 
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}"
                StrokeShape="Rectangle"
                StrokeThickness="0">
            <Border.Shadow>
                <Shadow Offset="0,1"
                        Brush="#20000000"
                        Radius="3" />
            </Border.Shadow>
            <Grid Padding="16,8" ColumnDefinitions="Auto,*,Auto">
                <Frame Grid.Column="0" 
                       HeightRequest="36" 
                       WidthRequest="36" 
                       CornerRadius="18" 
                       Padding="0" 
                       IsClippedToBounds="True"
                       BorderColor="Transparent">
                    <Image Source="{Binding Doctor.PhotoUrl}"
                           Aspect="AspectFill"/>
                </Frame>
                <VerticalStackLayout Grid.Column="1" Margin="12,0" Spacing="2">
                    <Label Text="{Binding Doctor.Name}" 
                           Style="{StaticResource DoctorNameStyle}"/>
                    <Label Text="{Binding Doctor.Specialty}" 
                           Style="{StaticResource DoctorSpecialtyStyle}"/>
                </VerticalStackLayout>
                <Label Grid.Column="2" 
                       Text="Online"
                       Style="{StaticResource OnlineStatusStyle}"
                       IsVisible="{Binding Doctor.IsOnline}"
                       VerticalOptions="Center"/>
            </Grid>
        </Border>

        <!-- Message List -->
        <CollectionView Grid.Row="1" 
                       ItemsSource="{Binding Messages}"
                       ItemsUpdatingScrollMode="KeepLastItemInView"
                       Margin="8,0">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ChatMessage">
                    <Grid Padding="4,2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Doctor Avatar (only for incoming messages) -->
                        <Frame IsVisible="{Binding SenderId, Converter={StaticResource MessageBackgroundConverter}, ConverterParameter='avatar'}"
                               Grid.Column="0"
                               HeightRequest="28" 
                               WidthRequest="28"
                               CornerRadius="14"
                               Padding="0"
                               Margin="0,0,8,0"
                               IsClippedToBounds="True"
                               BorderColor="Transparent">
                            <Image Source="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Doctor.PhotoUrl}"
                                   Aspect="AspectFill"/>
                        </Frame>

                        <Frame Grid.Column="{Binding SenderId, Converter={StaticResource MessageBackgroundConverter}, ConverterParameter='column'}"
                               Style="{StaticResource MessageFrameStyle}"
                               BackgroundColor="{Binding SenderId, Converter={StaticResource MessageBackgroundConverter}}"
                               HorizontalOptions="{Binding SenderId, Converter={StaticResource MessageBackgroundConverter}}"
                               Margin="{Binding SenderId, Converter={StaticResource MessageBackgroundConverter}}">
                            <VerticalStackLayout Spacing="2">
                                <Label Text="{Binding Content}" 
                                       Style="{StaticResource MessageTextStyle}"/>
                                <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                       Style="{StaticResource TimestampStyle}"/>
                            </VerticalStackLayout>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Message Input -->
        <Border Grid.Row="2"
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}"
                StrokeShape="Rectangle"
                StrokeThickness="0">
            <Border.Shadow>
                <Shadow Offset="0,-1"
                        Brush="#20000000"
                        Radius="3" />
            </Border.Shadow>
            <Grid ColumnDefinitions="Auto,*,Auto" 
                  Padding="8,12">
                <Button Grid.Column="0" 
                        Text="ðŸ“Ž"
                        Command="{Binding AttachPhotoCommand}"
                        Style="{StaticResource ActionButtonStyle}"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource Primary}"
                        Margin="0,0,8,0"/>
                
                <Frame Grid.Column="1"
                       Style="{StaticResource InputFrameStyle}"
                       VerticalOptions="Center">
                    <Entry Text="{Binding MessageText}" 
                           Placeholder="Message"
                           Style="{StaticResource InputEntryStyle}"/>
                </Frame>
                
                <Button Grid.Column="2" 
                        Text="âž¤"
                        Command="{Binding SendMessageCommand}"
                        Style="{StaticResource ActionButtonStyle}"
                        Margin="8,0,0,0"/>
            </Grid>
        </Border>
    </Grid>

</ContentPage> 