<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="HairCarePlus.Client.Patient.Features.PhotoCapture.Views.PhotoCapturePage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:HairCarePlus.Client.Patient.Features.PhotoCapture.ViewModels"
    xmlns:models="clr-namespace:HairCarePlus.Client.Patient.Features.PhotoCapture.Domain.Entities"
    xmlns:converters="clr-namespace:HairCarePlus.Client.Patient.Features.PhotoCapture.Converters"
    xmlns:common="clr-namespace:HairCarePlus.Client.Patient.Common.Converters"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    x:DataType="vm:PhotoCaptureViewModel"
    Shell.NavBarIsVisible="False"
    BackgroundColor="{AppThemeBinding Light=#F7F7F7, Dark=#1C1C1E}"
    xmlns:ios="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;assembly=Microsoft.Maui.Controls"
    ios:Page.UseSafeArea="False"
    Shell.TabBarIsVisible="False"
    NavigationPage.HasNavigationBar="False"
    Shell.BackgroundColor="{AppThemeBinding Light=#F7F7F7, Dark=#121212}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="..\Styles\PhotoCaptureStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <converters:EqualityConverter x:Key="EqualityConverter" />
            <converters:LuxOkConverter x:Key="LuxOkConverter" />
            <common:InverseBoolConverter x:Key="InverseBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        
        <!-- Top bar: template selector + switch camera button -->
        <Grid ColumnDefinitions="*,Auto" VerticalOptions="Start" HorizontalOptions="Fill" ZIndex="1" Margin="20,80,20,0">
            <!-- Zone selector -->
            <CollectionView
                ItemsSource="{Binding Templates}"
                SelectionMode="Single"
                SelectedItem="{Binding SelectedTemplate}"
                x:Name="TemplatesCollection"
                HorizontalScrollBarVisibility="Never"
                HeightRequest="44">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Horizontal" ItemSpacing="16" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:CaptureTemplate">
                        <Border Style="{StaticResource CaptureTemplateChipStyle}"
                                IsEnabled="{Binding IsCaptured, Converter={StaticResource InverseBoolConverter}}">
                            <Grid>
                                <Label x:Name="PART_Text" Text="{Binding Name}" FontSize="14" />
                                <Label Text="✓" IsVisible="{Binding IsCaptured}" HorizontalOptions="End" VerticalOptions="Center" />
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- Camera preview with overlay -->
        <Grid Grid.ZIndex="0">
            <!-- Actual camera preview -->
            <toolkit:CameraView x:Name="Camera" HorizontalOptions="Fill" VerticalOptions="Fill" />

            <!-- Overlay image to guide user -->
            <Image Source="{Binding SelectedTemplate.OverlayAsset}" Aspect="AspectFit" HorizontalOptions="Fill" VerticalOptions="Fill" />
        </Grid>

        <!-- Shutter button -->
        <Border Style="{StaticResource ShutterButtonStyle}" HorizontalOptions="Center" VerticalOptions="End" Margin="0,0,0,34" ZIndex="1" x:Name="ShutterBorder">
            <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnShutterTapped" />
            </Border.GestureRecognizers>
            <Border HeightRequest="64" WidthRequest="64" BackgroundColor="White" StrokeThickness="0" StrokeShape="RoundRectangle 32" />
        </Border>

        <!-- Switch camera circle button -->
        <Border Style="{StaticResource CircleIconButtonStyle}"
                ZIndex="1"
                Margin="0,0,20,34"
                HorizontalOptions="End"
                VerticalOptions="End">
            <Border.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ToggleFacingCommand}" />
            </Border.GestureRecognizers>
            <Image Source="change_camera.png" HeightRequest="32" WidthRequest="32" HorizontalOptions="Center" VerticalOptions="Center" />
        </Border>
    </Grid>

    <!-- Header similar to ChatPage -->
    <Shell.TitleView>
        <Grid ColumnDefinitions="80,*,80">
            <Button Text="←"
                    Command="{Binding BackCommand}"
                    HorizontalOptions="Start"
                    FontSize="24"
                    FontAttributes="Bold"
                    TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                    BackgroundColor="Transparent"
                    Padding="0"
                    HeightRequest="44"
                    WidthRequest="44" />
            <Label Grid.Column="1"
                   Text="Camera"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                   FontSize="18"
                   FontAttributes="Bold" />
        </Grid>
    </Shell.TitleView>
</ContentPage> 