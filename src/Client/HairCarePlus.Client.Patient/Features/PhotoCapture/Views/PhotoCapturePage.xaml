<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="HairCarePlus.Client.Patient.Features.PhotoCapture.Views.PhotoCapturePage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:HairCarePlus.Client.Patient.Features.PhotoCapture.ViewModels"
    xmlns:models="clr-namespace:HairCarePlus.Client.Patient.Features.PhotoCapture.Domain.Entities"
    xmlns:converters="clr-namespace:HairCarePlus.Client.Patient.Features.PhotoCapture.Converters"
    xmlns:common="clr-namespace:HairCarePlus.Client.Patient.Common.Converters"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:behaviors="clr-namespace:HairCarePlus.Client.Patient.Common.Behaviors"
    x:DataType="vm:PhotoCaptureViewModel"
    BackgroundColor="{AppThemeBinding Light=#F7F7F7, Dark=#1C1C1E}"
    xmlns:ios="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;assembly=Microsoft.Maui.Controls"
    ios:Page.UseSafeArea="False"
    Shell.TabBarIsVisible="False"
    NavigationPage.HasNavigationBar="False"
    Shell.BackgroundColor="{AppThemeBinding Light=#F7F7F7, Dark=#121212}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="..\Styles\PhotoCaptureStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <converters:NameToInitialConverter x:Key="NameToInitialConverter" />
            <common:InverseBoolConverter x:Key="InverseBoolConverter" />
            
            <Style x:Key="CaptureIndicatorStyle" TargetType="Border">
                <Setter Property="HeightRequest" Value="42" />
                <Setter Property="WidthRequest" Value="42" />
                <Setter Property="Stroke" Value="White" />
                <Setter Property="StrokeThickness" Value="2" />
                <Setter Property="StrokeShape" Value="Ellipse" />
                <Setter Property="BackgroundColor" Value="Transparent" />
            </Style>

            <Style x:Key="CaptureIndicatorLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="VerticalOptions" Value="Center" />
                <Setter Property="TextColor" Value="White" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid IgnoreSafeArea="True" RowDefinitions="*,Auto,Auto">

        <!-- Instruction Text -->
        <Label Grid.Row="0"
               Text="{Binding InstructionText}"
               HorizontalOptions="Center"
               VerticalOptions="Start"
               Margin="0,12,0,0"
               TextColor="White"
               FontSize="18"
               FontAttributes="Bold"
               Opacity="0">
            <Label.Triggers>
                <DataTrigger TargetType="Label" Binding="{Binding ShowInstruction}" Value="True">
                    <DataTrigger.EnterActions>
                        <behaviors:FadeToAction Opacity="0.9" Length="300" />
                    </DataTrigger.EnterActions>
                    <DataTrigger.ExitActions>
                        <behaviors:FadeToAction Opacity="0" Length="300" />
                    </DataTrigger.ExitActions>
                </DataTrigger>
            </Label.Triggers>
        </Label>

        <!-- Camera preview with overlay -->
        <Grid Grid.Row="0" Grid.RowSpan="3" ZIndex="-1">
            <toolkit:CameraView x:Name="Camera" HorizontalOptions="Fill" VerticalOptions="Fill" />
            <Image Source="{Binding SelectedTemplate.OverlayAsset}" Aspect="AspectFit" HorizontalOptions="Fill" VerticalOptions="Fill" />
        </Grid>

        <!-- Numeric zone selector placed just above action bar -->
        <HorizontalStackLayout Grid.Row="1" BindableLayout.ItemsSource="{Binding Templates}"
                               HorizontalOptions="Center"
                               Spacing="20"
                               Margin="0,0,0,12">
            <BindableLayout.ItemTemplate>
                <DataTemplate x:DataType="models:CaptureTemplate">
                    <Border Style="{StaticResource CaptureIndicatorStyle}">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border" Binding="{Binding IsCaptured}" Value="True">
                                <Setter Property="BackgroundColor" Value="White" />
                                <Setter Property="StrokeThickness" Value="0" />
                            </DataTrigger>
                        </Border.Triggers>
                        <Label Text="{Binding Name, Converter={StaticResource NameToInitialConverter}}"
                               Style="{StaticResource CaptureIndicatorLabelStyle}">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding IsCaptured}" Value="True">
                                    <Setter Property="TextColor" Value="Black" />
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                    </Border>
                </DataTemplate>
            </BindableLayout.ItemTemplate>
        </HorizontalStackLayout>

        <!-- Bottom action bar -->
        <Grid Grid.Row="2"
              BackgroundColor="{AppThemeBinding Light=#000000, Dark=#000000}"
              Padding="0,0,0,34"
              HeightRequest="120"
              ColumnDefinitions="*,Auto,*">
            <!-- Shutter Button (centered) -->
            <Border Grid.Column="1" Style="{StaticResource ShutterButtonStyle}" VerticalOptions="Start" HorizontalOptions="Center" Margin="0,12,0,0">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnShutterTapped" />
                </Border.GestureRecognizers>
                <Border HeightRequest="64" WidthRequest="64" BackgroundColor="White" StrokeThickness="0" StrokeShape="RoundRectangle 32" />
            </Border>

            <!-- Switch camera – immediately to the right of shutter -->
            <Border Grid.Column="2"
                    Style="{StaticResource CircleIconButtonStyle}"
                    BackgroundColor="{AppThemeBinding Light=#D1D1D6, Dark=#3A3A3C}"
                    VerticalOptions="Start" HorizontalOptions="Start" Margin="40,12,0,0">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding ToggleFacingCommand}" />
                </Border.GestureRecognizers>
                <Image Source="change_camera.png" HeightRequest="32" WidthRequest="32" HorizontalOptions="Center" VerticalOptions="Center" />
            </Border>
        </Grid>
    </Grid>

    <!-- Header similar to ChatPage -->
    <Shell.TitleView>
        <Grid ColumnDefinitions="80,*,80">
            <Button Text="←"
                    Command="{Binding BackCommand}"
                    HorizontalOptions="Start"
                    FontSize="24"
                    FontAttributes="Bold"
                    TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                    BackgroundColor="Transparent"
                    Padding="0"
                    HeightRequest="44"
                    WidthRequest="44" />
            <Label Grid.Column="1"
                   Text="Camera"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                   FontSize="18"
                   FontAttributes="Bold" />
        </Grid>
    </Shell.TitleView>
</ContentPage> 