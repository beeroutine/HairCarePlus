# План ревью и исправления ошибки InvalidCastException в HairCarePlus

## Ошибка
> Произошла ошибка при загрузке календаря: Specified cast is not valid. 
> Тип: InvalidCastException
> Ошибка происходит в строке 22 файла Features_Calendar_Views_CalendarPage.xaml.sg.cs и строке 65 файла CalendarPage.xaml.cs

## Потенциальные причины
1. Несоответствие типов при привязке данных в XAML
2. Неправильное использование стилей для разных типов элементов управления
3. Проблемы с конвертерами типов данных
4. Ошибки в обработке CommandParameter в командах
5. Проблемы с инициализацией коллекций в ViewModel

## План ревью и исправления

### 1. Исправление стилей в CalendarPage.xaml
- [x] Проверить стиль `CalendarDayStyle`, который применяется и к кнопкам (Button) и к меткам (Label)
- [x] Создать отдельные стили для разных типов элементов или использовать правильные стили

**Результаты исправления:**
- Создан новый стиль `CalendarDayButtonStyle` для кнопок
- Создан новый стиль `CalendarDayLabelStyle` для меток
- Исправлены все использования стилей в сетке календаря

### 2. Проверка конвертеров
- [x] Проверить наличие и корректность реализации всех используемых конвертеров
- [x] Проверить корректность использования `BooleanInvertConverter` в CalendarPage.xaml
- [x] Проверить конвертеры, указанные в App.xaml: `DoubleToPercentageConverter`, `HasItemsConverter`, `EventTypeToBackgroundConverter`

**Результаты исправления:**
- Найдены реализации всех конвертеров в файле CalendarValueConverters.cs
- Убедились в корректности их реализации
- BooleanInvertConverter используется правильно для инверсии IsMonthViewVisible

### 3. Исправление типов в CommandParameter
- [x] Проверить передачу и обработку CommandParameter в методе ExecuteDaySelected
- [x] Убедиться, что типы параметров соответствуют ожидаемым в обработчиках команд

**Результаты исправления:**
- Улучшена обработка CommandParameter в ExecuteDaySelected
- Добавлена проверка на null и валидность дня для месяца
- Добавлено преобразование строки в целое число с проверкой

### 4. Улучшение обработки коллекций
- [x] Улучшить обработку ошибок в методе LoadEventsForSelectedDay
- [x] Обеспечить, что SelectedDayEvents никогда не станет null
- [x] Изменить логику проверки HasSelectedDayEvents для защиты от null

**Результаты исправления:**
- Инициализирована коллекция _selectedDayEvents по умолчанию
- Добавлена защита от null в сеттере SelectedDayEvents
- Улучшена реализация HasSelectedDayEvents с использованием _selectedDayEvents
- Исключения обрабатываются локально, без пробрасывания

### 5. Проверка привязок данных
- [x] Проверить все привязки данных на корректность типов
- [x] Особое внимание уделить DataTemplate для CollectionView
- [x] Проверить использование x:DataType в привязках

**Результаты исправления:**
- В CalendarPage.xaml.cs изменен порядок инициализации: сначала ViewModel, затем InitializeComponent
- Добавлена специальная обработка InvalidCastException 
- Добавлена защита от null при работе с коллекциями

### 6. Тестирование исправлений
- [ ] Проверить корректность загрузки календаря
- [ ] Проверить отображение событий
- [ ] Проверить навигацию между месяцами
- [ ] Проверить выбор дня и отображение деталей

## Предложения по рефакторингу

После тестирования исправлений рекомендуется:

- [ ] Улучшить структуру кода с использованием патернов DDD/MVVM
  - Переработать логику представления CalendarPage для более четкого разделения UI и логики
  - Использовать DI для инъекции зависимостей в ViewModel
  
- [ ] Улучшить обработку ошибок и логирование
  - Добавить структурированное логирование с использованием подходящей библиотеки
  - Создать специализированный обработчик ошибок для UI слоя
  
- [ ] Оптимизировать загрузку данных
  - Реализовать кэширование событий календаря
  - Добавить асинхронную загрузку с индикатором прогресса
  
- [ ] Улучшить UI/UX календаря
  - Добавить подсветку текущего дня
  - Улучшить отображение индикаторов событий
  - Добавить анимации при переключении между видами

## Итоги исправлений

Основные причины ошибки InvalidCastException:

1. Неправильное применение стиля `CalendarDayStyle` к элементам разных типов
2. Проблемы с порядком инициализации ViewModel и компонентов UI
3. Отсутствие защиты от null в коллекциях и проверки типов параметров

Внесенные исправления должны устранить проблему с ошибкой InvalidCastException при загрузке календаря. Требуется тестирование для подтверждения результатов. 