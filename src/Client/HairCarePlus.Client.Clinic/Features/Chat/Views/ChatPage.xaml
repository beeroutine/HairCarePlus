<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:commonConverters="clr-namespace:HairCarePlus.Client.Clinic.Common.Converters"
             xmlns:behaviors="clr-namespace:HairCarePlus.Client.Clinic.Common.Behaviors"
             xmlns:model="clr-namespace:HairCarePlus.Client.Clinic.Features.Chat.Models"
             x:Class="HairCarePlus.Client.Clinic.Features.Chat.Views.ChatPage"
             BackgroundColor="{AppThemeBinding Light=#F7F7F7, Dark=#121212}"
             Shell.TabBarIsVisible="False"
             Shell.NavBarIsVisible="True"
             Shell.BackgroundColor="{AppThemeBinding Light=#F7F7F7, Dark=#121212}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <commonConverters:IsNotNullConverter x:Key="IsNotNullConverter" />
            <commonConverters:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
            <commonConverters:BoolToTextConverter x:Key="BoolToTextConverter" />
            <commonConverters:EqualityConverter x:Key="EqualityConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Title Bar -->
    <Shell.TitleView>
        <Grid ColumnDefinitions="80,*,80">
            <Button Text="←"
                    Command="{Binding BackCommand}"
                    HorizontalOptions="Start"
                    FontSize="24"
                    FontAttributes="Bold"
                    TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                    BackgroundColor="Transparent"
                    Shadow="{OnPlatform iOS={StaticResource SmallShadow}}"
                    Margin="0"
                    Padding="0"
                    HeightRequest="44"
                    WidthRequest="44" />

            <Label Grid.Column="1"
                   Text="{Binding Peer.Name}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                   FontSize="18"
                   FontAttributes="Bold" />

            <Label Grid.Column="2"
                   Text="{Binding Peer.IsOnline, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Online,Offline'}"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                   HorizontalOptions="End"
                   VerticalOptions="Center"
                   Margin="0,0,16,0"
                   FontSize="15" />
        </Grid>
    </Shell.TitleView>

    <Grid RowDefinitions="*,Auto">
        <!-- Messages -->
        <CollectionView Grid.Row="0"
                       x:Name="MessagesCollection"
                       ItemsSource="{Binding Messages}"
                       ItemsUpdatingScrollMode="KeepLastItemInView"
                       VerticalOptions="End"
                       Margin="8,8,8,0"
                       VerticalScrollBarVisibility="Never">
            <CollectionView.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding HideKeyboardCommand}" />
            </CollectionView.GestureRecognizers>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="model:ChatMessage">
                    <Grid Padding="4,4">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Message -->
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems Mode="Execute">
                                    <SwipeItem BackgroundColor="Transparent"
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditMessageCommand}"
                                               CommandParameter="{Binding .}"
                                               Text="Edit" />
                                    <SwipeItem BackgroundColor="{AppThemeBinding Light=#EF4444, Dark=#B91C1C}"
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteMessageCommand}"
                                               CommandParameter="{Binding .}"
                                               Text="Delete"
                                               IconImageSource="trash" />
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <Border x:Name="bubbleBorder"
                                    Grid.Column="0"
                                    BackgroundColor="{AppThemeBinding Light=#A0DAB2, Dark=#4D7B63}"
                                    HorizontalOptions="Start"
                                    Margin="8,6,80,6"
                                    StrokeShape="RoundRectangle 18"
                                    StrokeThickness="0"
                                    Shadow="{OnPlatform iOS={StaticResource SmallShadow}}"
                                    Padding="12,8">
                                <Border.Triggers>
                                    <!-- Settings for CURRENT user (doctor) messages -->
                                    <DataTrigger TargetType="Border" Binding="{Binding SenderId}" Value="doctor">
                                        <Setter Property="Grid.Column" Value="1" />
                                        <Setter Property="HorizontalOptions" Value="End" />
                                        <Setter Property="Margin" Value="80,6,8,6" />
                                        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#EAF4FC, Dark=#1E2A35}" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Border.Behaviors>
                                    <behaviors:VisualFeedbackBehavior />
                                </Border.Behaviors>
                                <Border.GestureRecognizers>
                                    <!-- Tap to reply -->
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.HandleReplyToMessageCommand}"
                                                         CommandParameter="{Binding .}" />
                                </Border.GestureRecognizers>
                                <VerticalStackLayout Spacing="2">
                                    <!-- Reply Preview -->
                                    <Grid IsVisible="{Binding ReplyTo, Converter={StaticResource IsNotNullConverter}}"
                                          Margin="0,0,0,4">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="4" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <BoxView Grid.Column="0"
                                                 BackgroundColor="{AppThemeBinding Light=#2D6A4F, Dark=#8FD5A6}"
                                                 CornerRadius="2"
                                                 Margin="0,2,0,2"
                                                 HorizontalOptions="Start" />

                                        <Frame Grid.Column="1"
                                               Padding="6,3"
                                               CornerRadius="8"
                                               BackgroundColor="{AppThemeBinding Light=#A0DAB2, Dark=#4D7B63}"
                                               Opacity="0.85"
                                               BorderColor="Transparent"
                                               HasShadow="False">
                                            <Frame.Triggers>
                                                <DataTrigger TargetType="Frame" Binding="{Binding ReplyTo.SenderId}" Value="doctor">
                                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#EAF4FC, Dark=#1E2A35}" />
                                                </DataTrigger>
                                            </Frame.Triggers>
                                            <StackLayout Orientation="Vertical" Spacing="2">
                                                <StackLayout Orientation="Horizontal" Spacing="3">
                                                    <Image Source="{FontImageSource FontFamily=MaterialIcons, Glyph=&#xe15e;, Size=12, Color={AppThemeBinding Light=#2D6A4F, Dark=#FFFFFF}}"
                                                           VerticalOptions="Center" />
                                                    <Label Text="{Binding ReplyTo.SenderId, StringFormat='Reply to {0}'}"
                                                           TextColor="{AppThemeBinding Light=#2D6A4F, Dark=#FFFFFF}"
                                                           FontSize="10"
                                                           FontAttributes="Bold"
                                                           VerticalOptions="Center">
                                                        <Label.Triggers>
                                                            <DataTrigger TargetType="Label" Binding="{Binding ReplyTo.SenderId}" Value="doctor">
                                                                <Setter Property="Text" Value="Reply to your message" />
                                                            </DataTrigger>
                                                        </Label.Triggers>
                                                    </Label>
                                                </StackLayout>
                                                <Label Text="{Binding ReplyTo.Content}"
                                                       TextColor="{AppThemeBinding Light=#105E29, Dark=#FFFFFF}"
                                                       FontSize="11"
                                                       MaxLines="1"
                                                       LineBreakMode="TailTruncation" />
                                            </StackLayout>
                                        </Frame>
                                    </Grid>

                                    <!-- Text content -->
                                    <Label Text="{Binding Content}"
                                           TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                                           FontSize="17"
                                           Margin="0,4,0,0"
                                           LineBreakMode="WordWrap"
                                           LineHeight="1.25"
                                           VerticalOptions="Center">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding SenderId}" Value="doctor">
                                                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />
                                            </DataTrigger>
                                            <DataTrigger TargetType="Label" Binding="{Binding Type}" Value="{x:Static model:MessageType.Image}">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>

                                    <!-- Image content -->
                                    <Image Source="{Binding LocalAttachmentPath}"
                                           Aspect="AspectFill"
                                           HeightRequest="200"
                                           IsVisible="False"
                                           Margin="0,4,0,0">
                                        <Image.Triggers>
                                            <DataTrigger TargetType="Image" Binding="{Binding Type}" Value="{x:Static model:MessageType.Image}">
                                                <Setter Property="IsVisible" Value="True" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>

                                    <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                           FontSize="11"
                                           Opacity="0.8"
                                           HorizontalOptions="End" />
                                </VerticalStackLayout>
                            </Border>
                        </SwipeView>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
            <CollectionView.Behaviors>
                <behaviors:AutoScrollToBottomBehavior />
            </CollectionView.Behaviors>
        </CollectionView>

        <!-- Input Panel -->
        <Grid Grid.Row="1"
              RowDefinitions="Auto,Auto,Auto"
              BackgroundColor="{AppThemeBinding Light=#F7F7F7, Dark=#121212}">

            <!-- Reply Preview -->
            <Grid Grid.Row="0"
                  IsVisible="{Binding ReplyToMessage, Converter={StaticResource IsNotNullConverter}}"
                  Margin="8,4,8,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="4" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- vertical bar -->
                <BoxView Grid.Column="0"
                         BackgroundColor="{AppThemeBinding Light=#2D6A4F, Dark=#8FD5A6}"
                         CornerRadius="2"
                         Margin="2,4,2,4" />

                <Frame Grid.Column="1"
                       BackgroundColor="{AppThemeBinding Light=#A0DAB2, Dark=#4D7B63}"
                       Opacity="0.85"
                       Padding="10,6"
                       CornerRadius="12"
                       BorderColor="Transparent"
                       HasShadow="False">
                    <Frame.Triggers>
                        <!-- if replying to doctor's own message (shouldn't normally happen) use blue -->
                        <DataTrigger TargetType="Frame" Binding="{Binding ReplyToMessage.SenderId}" Value="doctor">
                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#EAF4FC, Dark=#1E2A35}" />
                        </DataTrigger>
                    </Frame.Triggers>
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Spacing="2">
                            <StackLayout Orientation="Horizontal" Spacing="3">
                                <Image Source="{FontImageSource FontFamily=MaterialIcons, Glyph=&#xe15e;, Size=12, Color={AppThemeBinding Light=#2D6A4F, Dark=#FFFFFF}}"
                                       VerticalOptions="Center" />
                                <Label Text="Reply to patient's message"
                                       TextColor="{AppThemeBinding Light=#2D6A4F, Dark=#FFFFFF}"
                                       FontAttributes="Bold"
                                       FontSize="11">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding ReplyToMessage.SenderId}" Value="doctor">
                                            <Setter Property="Text" Value="Reply to your message" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </StackLayout>
                            <Label Text="{Binding ReplyToMessage.Content}"
                                   TextColor="{AppThemeBinding Light=#105E29, Dark=#FFFFFF}"
                                   FontSize="12"
                                   MaxLines="1"
                                   LineBreakMode="TailTruncation" />
                        </VerticalStackLayout>
                        <Button Grid.Column="1"
                                Text="×"
                                Command="{Binding CancelReplyCommand}"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#8E8E93, Dark=#636366}"
                                FontSize="20"
                                Padding="0"
                                Margin="-8,-8,-8,-8"
                                HeightRequest="36"
                                WidthRequest="36" />
                    </Grid>
                </Frame>
            </Grid>

            <!-- Input Controls -->
            <Grid Grid.Row="2" ColumnDefinitions="44,*,44" Padding="8,6,8,8">
                <Button Grid.Column="0"
                       Text="＋"
                       BackgroundColor="Transparent"
                       TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                       Shadow="{OnPlatform iOS={StaticResource SmallShadow}}"
                       FontSize="24"
                       Padding="0"
                       Margin="0"
                       HeightRequest="38"
                       WidthRequest="38"
                       VerticalOptions="Start"
                       x:Name="AttachmentButton">
                    <Button.Behaviors>
                        <behaviors:MenuFlyoutBehavior x:Name="AttachmentMenu" />
                    </Button.Behaviors>
                </Button>

                <Frame Grid.Column="1"
                       BackgroundColor="{AppThemeBinding Light=#EAF4FC, Dark=#1E2A35}"
                       Padding="8,0"
                       CornerRadius="18"
                       HasShadow="True"
                       Shadow="{OnPlatform iOS={StaticResource SmallShadow}}"
                       BorderColor="Transparent"
                       Margin="4,0,4,0"
                       MinimumHeightRequest="38"
                       MaximumHeightRequest="120"
                       VerticalOptions="Start">
                    <Editor Text="{Binding MessageText}"
                           Placeholder="Message"
                           PlaceholderColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                           TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                           BackgroundColor="Transparent"
                           FontSize="17"
                           AutoSize="TextChanges"
                           MaxLength="1000"
                           Keyboard="Chat"
                           VerticalTextAlignment="Center"
                           Margin="0,-2,0,-2" />
                </Frame>

                <Button Grid.Column="2"
                       IsVisible="{Binding MessageText, Converter={StaticResource StringNotEmptyConverter}}"
                       Text="↑"
                       Command="{Binding SendCommand}"
                       BackgroundColor="Transparent"
                       TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                       Shadow="{OnPlatform iOS={StaticResource SmallShadow}}"
                       FontSize="24"
                       FontAttributes="Bold"
                       Padding="0"
                       Margin="0"
                       HeightRequest="38"
                       WidthRequest="38"
                       VerticalOptions="Start" />
            </Grid>
        </Grid>
    </Grid>
</ContentPage> 