# HairCare+ Project Rules

> **Версия:** 1.0  
> **Назначение:** Эти правила определяют архитектурные, организационные и UX-принципы проекта HairCare+, а также описывают методы использования Think Tool и MCP Server в Cursor IDE.  
> **Авторы:** Команда HairCare+

---

## 1. Общие сведения

### 1.1 Назначение проекта
**HairCare+** — это комплексное цифровое решение для взаимодействия между клиниками и пациентами в постоперационный период. Решение включает три приложения:

1. **Patient Mobile Application (MAUI)**
   - Профиль пациента  
   - Локальное хранение и синхронизацию данных  
   - Чат с клиникой в режиме реального времени  
   - Календарь и уведомления  
   - Воспроизведение фото/видео  
   - Съёмку фотографий с AR-инструментами  
   - В дальнейшем — интеграцию с Server App и Clinic Mobile App  

2. **Server Application**
   - Центральная точка коммуникации  
   - Аутентификация и безопасность  
   - Синхронизация данных  
   - Работа с облаком  

3. **Clinic Mobile Application (MAUI)**
   - Управление персоналом клиники  
   - Мониторинг пациентов, аналитика  
   - Управление лечением  
   - Реальное время: чат, уведомления  
   - Диагностика (AI-интеграция)

### 1.2 Структура проекта
```
src/
├── Client/
│   ├── HairCarePlus.Client.Patient/
│   │   ├── Features/
│   │   │   ├── Authentication/
│   │   │   ├── Calendar/
│   │   │   ├── Chat/
│   │   │   ├── Media/
│   │   │   └── Notifications/
│   │   ├── Infrastructure/
│   │   └── Services/
│   └── HairCarePlus.Client.Clinic/
│       ├── Features/
│       │   ├── Authentication/
│       │   ├── PatientManagement/
│       │   ├── Analytics/
│       │   ├── Chat/
│       │   └── AIAssistant/
│       ├── Infrastructure/
│       └── Services/
├── Server/
│   ├── HairCarePlus.Server.API/
│   ├── HairCarePlus.Server.Application/
│   ├── HairCarePlus.Server.Domain/
│   └── HairCarePlus.Server.Infrastructure/
└── Shared/
    ├── HairCarePlus.Shared.Domain/
    ├── HairCarePlus.Shared.Communication/
    └── HairCarePlus.Shared.Common/
```

### 1.3 Технологический стек
- .NET 8
- .NET MAUI
- ASP.NET Core Web API
- Entity Framework Core
- SignalR (реальное время)
- Azure Services (или другой облачный провайдер)
- Clean Architecture, DDD, CQRS, SOLID, KISS
- MVVM (в MAUI-приложениях)
- Безопасность: JWT, HTTPS, шифрование данных, API-ключи, защищённое хранение

## 2. Архитектурные принципы
### 2.1 Clean Architecture & DDD
- Слои: Domain, Application, Infrastructure, UI (MAUI).
- Зависимости направлены к Domain (внутрь).
- DDD: Определяйте сущности, агрегаты, Value Objects, bounded contexts, придерживайтесь Ubiquitous Language.
- CQRS: Разделение команд (Commands) и запросов (Queries) для работы с данными.
- SOLID, KISS: Соблюдать принципы для повышения гибкости и упрощения.

### 2.2 Разделение кода
- Domain: доменные модели, бизнес-правила, агрегаты.
- Application: логика CQRS (обработчики, DTO), сервисы приложения.
- Infrastructure: базы данных, репозитории, внешние сервисы, поставщики.
- UI (MAUI): в Features/ храним конкретные модули (Authentication, Calendar, Chat и т. д.), отдельно Infrastructure/ и Services/ для кросс-функционального кода.

### 2.3 Именование и комментарии
- [FeatureName][Type].cs: Например, LoginViewModel.cs, AppointmentService.cs.
- #regions, TODO, REVIEW: использовать для навигации в коде.
- XML-документация для публичных методов, классов.

## 3. MAUI UI и паттерн MVVM
### 3.1 Коллекции и списки
ObservableCollection обновляем атомарно. При массовом изменении:

```csharp
var updatedList = new List<T>(MyCollection);
updatedList.AddRange(newItems);
MyCollection = new ObservableCollection<T>(updatedList);
```

- Не модифицируйте коллекцию из нескольких мест одновременно.
- Управление через ViewModel (команды, свойства), а не напрямую из View.

### 3.2 Потоки и производительность
- UI-поток: обновления только через MainThread.InvokeOnMainThreadAsync(...).
- Фоновые операции: длительные задачи в Task.Run(), результат – в UI-поток.
- Ограничение обновлений: минимизировать частые перерисовки.
- Кэширование: хранить часто используемые данные локально.

### 3.3 Компоненты интерфейса
- Виртуализация: CachingStrategy, ItemSizingStrategy для больших списков.
- Сбрасывание выделения: после выбора элемента.
- Бесконечная прокрутка: RemainingItemsThreshold + команда подгрузки.
- Очистка ресурсов: отписка от событий, освобождение компонентов в OnDisappearing.

### 3.4 iOS UICollectionView (особенности)
- Не обновляйте напрямую ObservableCollection, если она привязана к CollectionView.
- При массовых изменениях: batch-операции или полная замена коллекции.
- Проверяйте, что количество элементов совпадает с ожидаемым после обновления.

## 4. UI/UX Руководства
### 4.1 Общие принципы дизайна
- Современный flat-дизайн: минимализм, чистые формы, понятная типографика.
- Light/Dark темы, достаточный контраст, поддержка accessibility.
- Адаптивные макеты: интерфейс должен корректно выглядеть на разных устройствах.
- Официальные рекомендации .NET MAUI: следовать при проектировании интерфейсов.

### 4.2 Цветовая дифференциация категорий
- Лекарства/процедуры: #4B9BF8, иконка капсула.
- Осмотры/визиты: #A0DAB2, иконка стетоскоп.
- Фотоотчёты: #9747FF, иконка камера.
- Видео-инструкции: #FF9F1C, иконка учебная книга.
- Общие рекомендации: #8E8E93, иконка ℹ️.
- Критические предупреждения: #F14336, иконка ⚠️.

### 4.3 Календарь (пример)
- Цветовая гамма: для мужской аудитории 30+ используем глубокие оттенки синего/фиолетового (#6962AD).
- Типографика: 16–18px, полужирные заголовки.
- Минималистичность: только нужные детали (индикаторы событий).
- Профессиональный тон: строгий, без лишних украшений.

### 4.4 XAML-практики
- ResourceDictionary: для общих стилей, тем.
- x:DataType: для компиляционных проверок привязок.
- ControlTemplates: создание переиспользуемых компонентов.
- Форматирование: 4 пробела, выравнивание по вложенности.

## 5. Чат-Интерфейс: основные правила
- Реальное время: использовать SignalR (Server), отображать моментальные обновления.
- Статусы: при необходимости выводить "отправлено/доставлено/прочитано".
- UI-обработка: авто-прокрутка к последнему сообщению, размытие фона при вложениях.
- Стили: Patient vs Doctor отличаются цветом, выравниванием (право/лево).
- Безопасность: шифровать важные данные, не показывать конфиденциальные детали на экране блокировки.

## 6. Безопасность
- JWT: использовать для аутентификации, срок годности токена ограничивать, обновлять по рефреш-токену.
- HTTPS: все соединения должны идти по защищённому каналу.
- Secure Storage (MAUI) для хранения токенов и конфиденциальных данных на устройстве.
- Ключи и пароли: никогда не хардкодить, использовать переменные окружения, user secrets.

## 7. Обработка неопределённостей
- Не изобретай бизнес-логику, если нет данных. Сначала уточняй у заказчика/пользователя.
- Запрашивай подтверждение перед изменением критичных вещей (API, БД, доменных моделей).
- Не нарушай существующие принципы, если не получил на то согласие.

## 8. Использование Think Tool (MCP)
### 8.1 Когда использовать
- При сложных задачах: проектирование архитектуры, новых крупных модулей.
- При многослойных изменениях: затрагивающих Domain, Application, UI.
- При аналитике рисков (например, изменения в безопасности).

### 8.2 Как использовать
- Сформулируй задачу в общих чертах.
- Вызови команду think в Cursor IDE (MCP).
- Опиши в Think Tool детали, подзадачи, возможные варианты решений, риски.
- Вернись из Think Tool и выдай чёткий план в основном ответе.
- Не выводи пользователю содержимое своих внутренних мыслей из Think Tool.

## 9. Рекомендации по тестированию и качеству
- Unit-тесты: для доменных сервисов, команд CQRS.
- UI-тесты (MAUI): проверять ключевые сценарии (чат, календарь).
- Интеграционные тесты: проверить соединение с сервером, базами данных.
- Запуск: dotnet test. Исправлять ошибки до "чистого" прохождения тестов.
- Статический анализ: следовать линтерам, не игнорировать предупреждения.

## 10. Отладка и диагностика
- Структурированный лог (Serilog, NLog). Избегать простых Debug.WriteLine().
- Точки останова: при сложном коде использовать условные брейкпойнты.
- Отладка привязок (XAML): использовать StringFormat='Debug: {0}'.
- Безопасные вызовы: Command?.Execute(null) вместо Command.Execute(null).

## 11. Платформенный код (MAUI)
- Компиляционные директивы: #if ANDROID / #if IOS вместо DeviceInfo.Platform.
- Интерфейсы: для платформенных сервисов, используйте Dependency Injection.
- DI-регистрация: учитывайте разницу платформ (Android, iOS, Windows).

## 12. Итоговые инструкции при работе с Cursor IDE
- Следуй изложенным правилам (архитектура, UX, безопасность).
- Используй Think Tool при сложных или многоэтапных задачах.
- Уточняй детали у пользователя, если информации недостаточно.
- Поддерживай принцип MVVM: раздельные уровни (View, ViewModel, Service).
- Придерживайся Clean Architecture, DDD, CQRS.
- После генерации кода: проверяй стиль, запускай тесты.

## 13. Заключение
Этот документ описывает:
- Архитектурные и организационные правила HairCare+
- Ключевые паттерны (Clean Architecture, DDD, CQRS, SOLID)
- Рекомендации по UI/UX (MAUI)
- Интеграцию и применение Think Tool (MCP)
- Тестирование, безопасность, работу с базовой функциональностью

При дальнейшей разработке:
- Всегда придерживайтесь данного файла в качестве основного справочника.
- При внесении существенных изменений в проект обновляйте эти правила.
- Обсуждайте все изменения с командой, чтобы сохранить согласованность.

Спасибо за соблюдение принципов HairCare+!